name: Unit Tests

on:
  pull_request:
    branches: [ "master" ]
  push:
    branches: [ "master" ]

# Minimum coverage threshold for enforcement
env:
  COVERAGE_THRESHOLD: 50

jobs:
  test:
    runs-on: ${{ matrix.os }}
    
    permissions:
      contents: read
      checks: write
      pull-requests: write
      issues: write

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        build_type: [Debug, Release]
        c_compiler: [gcc, clang]
        include:
          - os: ubuntu-latest
            c_compiler: gcc
            cpp_compiler: g++
          - os: ubuntu-latest
            c_compiler: clang
            cpp_compiler: clang++

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for version detection

    - name: Set reusable strings
      id: strings
      shell: bash
      run: |
        echo "build-output-dir=${{ github.workspace }}/build" >> "$GITHUB_OUTPUT"
    
    - name: Make scripts executable
      run: chmod -R +x ./scripts/

    - name: Install Dependencies
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
          ./scripts/installUbuntuPreReqs.sh
        else
          echo "$RUNNER_OS not supported"
          exit 1
        fi
      shell: bash

    - name: Configure CMake
      run: >
        cmake -B ${{ steps.strings.outputs.build-output-dir }}
        -DCMAKE_CXX_COMPILER=${{ matrix.cpp_compiler }}
        -DCMAKE_C_COMPILER=${{ matrix.c_compiler }}
        -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
        -DBUILD_TESTS=ON
        -Dalloutput=${{ matrix.build_type == 'Debug' && matrix.c_compiler == 'gcc' && 'ON' || 'OFF' }}
        -S ${{ github.workspace }}

    - name: Build
      run: cmake --build ${{ steps.strings.outputs.build-output-dir }} --config ${{ matrix.build_type }}

    - name: Run Tests
      working-directory: ${{ steps.strings.outputs.build-output-dir }}
      run: ctest --build-config ${{ matrix.build_type }} --output-on-failure --verbose

    - name: Generate Coverage Report (Debug only)
      if: matrix.build_type == 'Debug' && matrix.c_compiler == 'gcc'
      id: coverage
      working-directory: ${{ steps.strings.outputs.build-output-dir }}
      run: |
        # Install gcovr if not available
        sudo apt-get update
        sudo apt-get install -y gcovr
        
        # Generate coverage report with JSON for parsing
        gcovr --root ${{ github.workspace }} \
              --filter '${{ github.workspace }}/src/' \
              --exclude '${{ github.workspace }}/src/glad/' \
              --exclude '${{ github.workspace }}/src/stb_*' \
              --exclude '${{ github.workspace }}/src/tinyFileDialogs/' \
              --print-summary \
              --json coverage.json \
              --txt coverage.txt \
              --html coverage.html
        
        # Display coverage summary
        echo "=== Coverage Summary ==="
        cat coverage.txt
        
        # Extract line coverage percentage from JSON for enforcement
        # Handles errors gracefully and defaults to 0 if file is missing or malformed
        LINE_COVERAGE=$(python3 -c "
import json
import sys
try:
    with open('coverage.json', 'r') as f:
        data = json.load(f)
    print(round(data.get('line_percent', 0), 2))
except (FileNotFoundError, json.JSONDecodeError, KeyError) as e:
    print('Error reading coverage.json:', e, file=sys.stderr)
    print(0)
" 2>&1 | tail -1)
        echo "Line coverage: ${LINE_COVERAGE}%"
        echo "line_coverage=${LINE_COVERAGE}" >> "$GITHUB_OUTPUT"
        
        # Extract branch coverage if available
        BRANCH_COVERAGE=$(python3 -c "
import json
try:
    with open('coverage.json', 'r') as f:
        data = json.load(f)
    print(round(data.get('branch_percent', 0), 2))
except:
    print(0)
" 2>&1 | tail -1)
        echo "Branch coverage: ${BRANCH_COVERAGE}%"
        echo "branch_coverage=${BRANCH_COVERAGE}" >> "$GITHUB_OUTPUT"

    - name: Enforce Coverage Threshold
      if: matrix.build_type == 'Debug' && matrix.c_compiler == 'gcc'
      run: |
        LINE_COVERAGE=${{ steps.coverage.outputs.line_coverage }}
        THRESHOLD=${{ env.COVERAGE_THRESHOLD }}
        
        echo "Line coverage: ${LINE_COVERAGE}%"
        echo "Threshold: ${THRESHOLD}%"
        
        # Compare as integers to avoid floating point issues
        # Handle case where LINE_COVERAGE might not have a decimal point
        if [[ "${LINE_COVERAGE}" == *"."* ]]; then
          LINE_INT="${LINE_COVERAGE%%.*}"
        else
          LINE_INT="${LINE_COVERAGE}"
        fi
        
        # Ensure LINE_INT is numeric, default to 0 if empty or non-numeric
        if ! [[ "${LINE_INT}" =~ ^[0-9]+$ ]]; then
          echo "Warning: Could not parse coverage value '${LINE_COVERAGE}', defaulting to 0"
          LINE_INT=0
        fi
        
        if [ "${LINE_INT}" -lt "${THRESHOLD}" ]; then
          echo "âŒ Coverage ${LINE_COVERAGE}% is below threshold ${THRESHOLD}%"
          exit 1
        else
          echo "âœ… Coverage ${LINE_COVERAGE}% meets threshold ${THRESHOLD}%"
        fi

    - name: Comment Coverage on PR
      if: matrix.build_type == 'Debug' && matrix.c_compiler == 'gcc' && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const lineCoverage = '${{ steps.coverage.outputs.line_coverage }}';
          const branchCoverage = '${{ steps.coverage.outputs.branch_coverage }}';
          const threshold = '${{ env.COVERAGE_THRESHOLD }}';
          
          const coverageInt = parseInt(lineCoverage);
          const thresholdInt = parseInt(threshold);
          const status = coverageInt >= thresholdInt ? 'âœ…' : 'âŒ';
          
          const body = `## ðŸ“Š Code Coverage Report
          
          | Metric | Value | Status |
          |--------|-------|--------|
          | Line Coverage | ${lineCoverage}% | ${status} |
          | Branch Coverage | ${branchCoverage}% | - |
          | Threshold | ${threshold}% | - |
          
          ${coverageInt >= thresholdInt ? 'âœ… Coverage meets threshold!' : 'âŒ Coverage is below threshold!'}
          
          > Third-party code excluded: glad, stb_*, tinyFileDialogs
          `;
          
          // Find existing comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('Code Coverage Report')
          );
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
          }

    - name: Upload Coverage Report
      if: matrix.build_type == 'Debug' && matrix.c_compiler == 'gcc'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: |
          ${{ steps.strings.outputs.build-output-dir }}/coverage.txt
          ${{ steps.strings.outputs.build-output-dir }}/coverage.html
          ${{ steps.strings.outputs.build-output-dir }}/coverage.json

    - name: Check Test Results
      if: always()
      run: |
        if [ -f "${{ steps.strings.outputs.build-output-dir }}/Testing/Temporary/LastTest.log" ]; then
          echo "Test log:"
          cat "${{ steps.strings.outputs.build-output-dir }}/Testing/Temporary/LastTest.log"
        fi
