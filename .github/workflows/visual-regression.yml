name: Visual Regression Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  visual-tests:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set reusable strings
      id: strings
      shell: bash
      run: |
        echo "build-output-dir=${{ github.workspace }}/build" >> "$GITHUB_OUTPUT"

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential cmake \
          libglfw3-dev libglm-dev \
          mesa-utils xvfb \
          libgl1-mesa-dev libglu1-mesa-dev

    - name: Configure CMake
      run: |
        cmake -B ${{ steps.strings.outputs.build-output-dir }} \
          -DCMAKE_CXX_COMPILER=g++ \
          -DCMAKE_C_COMPILER=gcc \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_TESTS=ON \
          -S ${{ github.workspace }}

    - name: Build Tests
      run: |
        cmake --build ${{ steps.strings.outputs.build-output-dir }} \
          --config Release \
          --target ParticleViewerTests

    - name: Run Visual Regression Tests
      id: visual-tests
      working-directory: ${{ steps.strings.outputs.build-output-dir }}/tests
      run: |
        # Run only visual regression test suites under Xvfb
        xvfb-run -a ./ParticleViewerTests \
          --gtest_filter="VisualRegressionTest.*:VisualMacroTest.*:VisualHelperTest.*" \
          --gtest_output=xml:visual-test-results.xml \
          2>&1 | tee visual-test-output.txt

        # Capture exit code
        TEST_EXIT_CODE=${PIPESTATUS[0]}
        echo "test_exit_code=${TEST_EXIT_CODE}" >> "$GITHUB_OUTPUT"

        # Parse test results for the comment
        TOTAL=$(grep -oP '\d+(?= tests? from)' visual-test-output.txt | tail -1 || echo "0")
        PASSED=$(grep -oP '\d+(?= tests?\.)' visual-test-output.txt | tail -1 || echo "0")
        FAILED=$(grep -oP '\d+(?= tests? FAILED)' visual-test-output.txt | tail -1 || echo "0")

        echo "total_tests=${TOTAL}" >> "$GITHUB_OUTPUT"
        echo "passed_tests=${PASSED}" >> "$GITHUB_OUTPUT"
        echo "failed_tests=${FAILED}" >> "$GITHUB_OUTPUT"

        exit ${TEST_EXIT_CODE}

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: visual-regression-results
        path: |
          ${{ steps.strings.outputs.build-output-dir }}/tests/visual-test-results.xml
          ${{ steps.strings.outputs.build-output-dir }}/tests/visual-test-output.txt
        retention-days: 7

    - name: Upload Diff Images on Failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: visual-regression-diffs
        path: |
          ${{ steps.strings.outputs.build-output-dir }}/tests/diffs/
          ${{ steps.strings.outputs.build-output-dir }}/tests/artifacts/
        retention-days: 7
        if-no-files-found: ignore

    - name: Comment Visual Diff on PR
      if: always() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const testExitCode = '${{ steps.visual-tests.outputs.test_exit_code }}';
          const total = '${{ steps.visual-tests.outputs.total_tests }}' || '0';
          const passed = '${{ steps.visual-tests.outputs.passed_tests }}' || '0';
          const failed = '${{ steps.visual-tests.outputs.failed_tests }}' || '0';
          const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

          const status = testExitCode === '0' ? 'âœ…' : 'âŒ';
          const statusText = testExitCode === '0' ? 'All visual tests passed!' : 'Visual regression detected!';

          let body = `## ðŸŽ¨ Visual Regression Test Report\n\n`;
          body += `**Status:** ${status} ${statusText}\n\n`;
          body += `| Metric | Value |\n`;
          body += `|--------|-------|\n`;
          body += `| Total Tests | ${total} |\n`;
          body += `| Passed | ${passed} |\n`;
          body += `| Failed | ${failed} |\n\n`;

          if (testExitCode !== '0') {
            body += `### ðŸ“¸ Diff Artifacts\n\n`;
            body += `Download diff images from the [workflow run artifacts](${runUrl}).\n\n`;
            body += `**Artifacts include:**\n`;
            body += `- \`*_diff.png\` â€” Highlighted pixel differences\n`;
            body += `- \`*_baseline.png\` â€” Expected baseline image\n`;
            body += `- \`*_current.png\` â€” Actual rendered image\n\n`;
          }

          body += `---\n`;
          body += `*Generated by [Visual Regression Tests](${runUrl})*`;

          // Find existing comment to update (don't spam)
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const botComment = comments.find(comment =>
            comment.user.type === 'Bot' &&
            comment.body.includes('Visual Regression Test Report')
          );

          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
          }
