name: Build Flatpak (PR)

on:
  pull_request:
    branches: [ "master" ]
    paths:
      - 'src/**'
      - 'CMakeLists.txt'
      - 'flatpak/**'
      - 'scripts/build-flatpak.sh'
      - '.github/workflows/flatpak-pr.yml'

jobs:
  build-flatpak:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for version detection
      
      - name: Calculate prerelease version
        id: version
        run: |
          # Get the most recent tag that matches semantic versioning pattern (vX.Y.Z)
          RAW_VERSION=$(git tag -l "v[0-9]*.[0-9]*.[0-9]*" --sort=-v:refname | head -n 1)
          if [ -z "$RAW_VERSION" ]; then
            RAW_VERSION="v0.0.0"
          fi
          
          # Strip the 'v' prefix
          BASE_VERSION="${RAW_VERSION#v}"
          
          # Create prerelease version with PR number
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PRERELEASE_VERSION="${BASE_VERSION}-pr.${PR_NUMBER}"
          
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "prerelease_version=$PRERELEASE_VERSION" >> $GITHUB_OUTPUT
          echo "Prerelease version: $PRERELEASE_VERSION"
      
      - name: Update Flatpak metainfo with prerelease version
        run: |
          PRERELEASE_VERSION="${{ steps.version.outputs.prerelease_version }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          DATE=$(date +%Y-%m-%d)
          METAINFO_FILE="flatpak/org.particleviewer.ParticleViewer.metainfo.xml"
          
          # Create temporary file with new prerelease entry
          cat > /tmp/new_release.txt << RELEASE_EOF
            <release version="$PRERELEASE_VERSION" date="$DATE" type="development">
              <description>
                <p>Prerelease build for PR #$PR_NUMBER</p>
              </description>
            </release>
          RELEASE_EOF
          
          # Use awk to insert the new release entry after <releases> tag
          awk -v new_release="$(cat /tmp/new_release.txt)" '
          /<releases>/ { print; print new_release; next }
          { print }
          ' "$METAINFO_FILE" > "${METAINFO_FILE}.tmp"
          
          mv "${METAINFO_FILE}.tmp" "$METAINFO_FILE"
          
          echo "Updated metainfo.xml with prerelease version $PRERELEASE_VERSION"
      
      - name: Update Flatpak manifest with prerelease version
        run: |
          PRERELEASE_VERSION="${{ steps.version.outputs.prerelease_version }}"
          MANIFEST_FILE="flatpak/org.particleviewer.ParticleViewer.yaml"
          
          # Add PROJECT_VERSION to config-opts
          # Use yq if available, otherwise use sed
          if ! command -v yq &> /dev/null; then
            # Use sed to add the PROJECT_VERSION option after BUILD_TESTS=OFF
            sed -i "/- -DBUILD_TESTS=OFF/a\\      - -DPROJECT_VERSION=$PRERELEASE_VERSION" "$MANIFEST_FILE"
          else
            yq eval ".modules[-1].config-opts += [\"-DPROJECT_VERSION=$PRERELEASE_VERSION\"]" -i "$MANIFEST_FILE"
          fi
          
          echo "Updated Flatpak manifest with PROJECT_VERSION=$PRERELEASE_VERSION"
      
      - name: Install Flatpak and flatpak-builder
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          
      - name: Add Flathub repository
        run: |
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
      
      - name: Install Freedesktop SDK and Platform
        run: |
          sudo flatpak install -y flathub org.freedesktop.Platform//24.08 org.freedesktop.Sdk//24.08
      
      - name: Build Flatpak
        run: |
          flatpak-builder --force-clean --repo=repo build-dir flatpak/org.particleviewer.ParticleViewer.yaml
      
      - name: Create Flatpak bundle
        run: |
          PRERELEASE_VERSION="${{ steps.version.outputs.prerelease_version }}"
          flatpak build-bundle repo particle-viewer-${PRERELEASE_VERSION}.flatpak org.particleviewer.ParticleViewer
      
      - name: Upload Flatpak artifact
        uses: actions/upload-artifact@v4
        with:
          name: particle-viewer-flatpak-pr-${{ github.event.pull_request.number }}
          path: particle-viewer-${{ steps.version.outputs.prerelease_version }}.flatpak
          retention-days: 30
      
      - name: Comment PR with download link
        if: github.event.pull_request.head.repo.full_name == github.repository
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const runId = context.runId;
            const repo = context.repo;
            const prereleaseVersion = '${{ steps.version.outputs.prerelease_version }}';
            
            const commentMarker = '<!-- flatpak-build-comment -->';
            const comment = `${commentMarker}
## ðŸ“¦ Flatpak Build Complete

A prerelease Flatpak build has been created for this PR and is available for testing.

**Version:** \`${prereleaseVersion}\`

### Download & Install

1. Download the artifact from the [workflow run](https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId})
2. Extract the zip file to get \`particle-viewer-${prereleaseVersion}.flatpak\`
3. Install: \`flatpak install --user particle-viewer-${prereleaseVersion}.flatpak\`
4. Run: \`flatpak run org.particleviewer.ParticleViewer\`

### Testing

Please test the following:
- âœ… Application launches successfully
- âœ… File loading works correctly
- âœ… All features work in the sandboxed environment
- âœ… No dependency errors

**Note:** This is a prerelease/beta build for testing purposes.`;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: prNumber,
              owner: repo.owner,
              repo: repo.repo,
            });
            
            const existingComment = comments.find(c => c.body.includes(commentMarker));
            
            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: repo.owner,
                repo: repo.repo,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: repo.owner,
                repo: repo.repo,
                body: comment
              });
            }
